# Use the latest stable version of Semaphore 2.0 YML syntax:
version: v1.0

# Name your pipeline. In case you connect multiple pipelines with promotions,
# the name will help you differentiate between, for example, a CI build phase
# and delivery phases.
name: satpy pipeline

# An agent defines the environment in which your code runs.
# It is a combination of one of available machine types and operating
# system images.
# See https://docs.semaphoreci.com/article/20-machine-types
# and https://docs.semaphoreci.com/article/32-ubuntu-1804-image
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

# Blocks are the heart of a pipeline and are executed sequentially.
# Each block has a task that defines one or more jobs. Jobs define the
# commands to execute.
# See https://docs.semaphoreci.com/article/62-concepts
blocks:
  - name: "Install Dependencies"
    task:
      # This block install the required Linux packages
      # as well as the python dependencies.
      # The prologue section is always executed before each job on
      # the block.
      # See https://docs.semaphoreci.com/article/50-pipeline-yaml#prologue
      prologue:
        commands:
          # Set the python version to 3.7.
          # See https://docs.semaphoreci.com/article/54-toolbox-reference#sem-version
          - sem-version python 3.7
          # If we've got a cached conda environment already that matches the
          # environment.yml we stop here already
          #- cache has_key conda-env-$SEMAPHORE_GIT_BRANCH-$(checksum environment.yml) && exit 0 || true
          # Install miniconda, https://github.com/astrofrog/example-travis-conda/blob/master/.travis.yml
          - wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh
          - chmod +x miniconda.sh
          - ./miniconda.sh -b -p $HOME/miniconda
          - export PATH=$HOME/miniconda/bin:$PATH
          - conda update --yes conda
      jobs:
        - name: conda & pip
          commands:
            # Get the latest version of our source code from GitHub:
            # See https://docs.semaphoreci.com/article/54-toolbox-reference#checkout
            - checkout
            # handle requirements from conda
            - cache restore requirements-conda-$SEMAPHORE_GIT_BRANCH-$(checksum environment.yml),requirements-conda-$SEMAPHORE_GIT_BRANCH-,requirements-conda-master-
            # cache restore uses relative paths always, so we need to move things
            # ourselves. This might fail though so we ensure exitcode=0
            - mv home/semaphore/miniconda/pkgs/* $HOME/miniconda/pkgs || true
            # install requirements through conda
            - conda env create -f environment.yml
            - cache store requirements-conda-$SEMAPHORE_GIT_BRANCH-$(checksum environment.yml) $HOME/miniconda/pkgs
            - source activate satdata
            # cache everything related to conda so we don't have to install it
            # again and have our environment available later, we remove the packages though since we're done with them now
            - rm -rf $HOME/miniconda/pkgs
            - cache store conda-env-$SEMAPHORE_GIT_BRANCH-$(checksum environment.yml) $HOME/miniconda

  - name: "Run Unit Tests"
    task:
      # This block runs the unit tests.
      prologue:
        commands:
          - sem-version python 3.7
          - checkout
          # we need conda again
          - cache restore conda-env-$SEMAPHORE_GIT_BRANCH-$(checksum environment.yml)
          # cache restore uses relative paths always, so we need to move things
          # ourselves. This might fail though so we ensure exitcode=0
          - mv home/semaphore/miniconda/ $HOME/miniconda || true
          - export PATH=$HOME/miniconda/bin:$PATH
          - source activate satdata
          - pip install pytest
          - pip install .
      jobs:
        - name: Tests
          commands:
            - python -m pytest
